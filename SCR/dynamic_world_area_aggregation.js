var geometry = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[10.333055190530173, 59.704433833882405],
          [10.451720223706035, 59.54317856760941],
          [10.635179213967673, 59.45410553877239],
          [10.701097182717673, 59.19065792344536],
          [10.701097182717673, 58.94217106749486],
          [11.030687026467673, 58.9931442859917],
          [11.118577651467673, 59.09486477318654],
          [11.360276870217673, 59.13997729450203],
          [11.514085463967673, 58.936502722821416],
          [11.645921401467673, 58.998803324994924],
          [11.722825698342673, 59.19065792344536],
          [11.777757338967673, 59.28618325810229],
          [11.612962417092673, 59.60452599488652],
          [11.755784682717673, 59.68780318846231],
          [11.843675307717673, 59.79299120471558],
          [11.722825698342673, 60.05725803962274],
          [11.547044448342673, 60.15581629147681],
          [11.459153823342673, 60.25953039223088],
          [11.272386245217673, 60.39006955871449],
          [11.184495620217673, 60.503863701906674],
          [11.151536635842673, 60.57410812019912],
          [11.096604995217673, 60.50927253252037],
          [10.832933120217673, 60.444306959012],
          [10.723069838967673, 60.465976603978405],
          [10.931810073342673, 60.40635027592216],
          [10.953782729592673, 60.319425636015524],
          [10.832933120217673, 60.28132317703108],
          [10.327562026467673, 60.28676910555206],
          [10.250657729592673, 60.34117852983267],
          [10.052903823342673, 60.465976603978405],
          [10.028184585061423, 60.59972711934252],
          [9.959520034280173, 60.6239877375226],
          [9.975992184604356, 60.61454846528305],
          [9.937525360027072, 60.5943344072464],
          [9.888108901467673, 60.57949600117914],
          [9.833177260842673, 60.53899573389177],
          [9.899095229592673, 60.4578429240279],
          [9.822190932717673, 60.43074682184625],
          [9.602464370217673, 60.50114970291184],
          [9.404710463967673, 60.52818709430065],
          [9.338792495217673, 60.61455522001532],
          [9.261888198342673, 60.727563538048656],
          [9.152024917092673, 60.775874318884384],
          [8.866380385842673, 60.88297141856115],
          [8.655188184493733, 60.906420966483694],
          [8.514817885842673, 60.9897103093815],
          [8.306077651467673, 61.011015175387485],
          [8.245536800289996, 60.96707252895174],
          [8.108323745217673, 60.93638558832352],
          [8.082111569015295, 60.88834272223673],
          [7.888597182717674, 60.8669297096516],
          [7.778733901467674, 60.80268222113145],
          [7.756641776297517, 60.73962211303264],
          [7.635911635842674, 60.69531592217877],
          [7.567247085061424, 60.689265891306924],
          [7.657884292092674, 60.65765279143281],
          [7.756761245217674, 60.53899573389177],
          [7.723802260842674, 60.36562392756484],
          [7.602952651467674, 60.15307319895811],
          [7.811692885842674, 60.14213592927642],
          [8.097337417092673, 60.207705002100774],
          [8.382981948342673, 60.19678591146744],
          [8.701585463967673, 60.207705002100774],
          [8.899339370217673, 60.16400683120625],
          [8.976243667092673, 60.103826828888394],
          [9.031175307717673, 60.04902216100538],
          [9.042161635842673, 59.99962004811569],
          [9.195970229592673, 59.96114510353437],
          [9.236837281630184, 59.84222704045716],
          [9.44297476109079, 59.75506522420387],
          [9.567182756500898, 59.52216385025981],
          [9.737758193359895, 59.43279037798038],
          [9.725322095151471, 59.48979837270648],
          [9.833838182438045, 59.50494327029045],
          [9.915274697889362, 59.641070692000135],
          [9.989472883693375, 59.688175953113905]]]),
    geometry2 = /* color: #d63000 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.238775865990545,
                61.078614562248106
              ],
              [
                8.217489855248358,
                61.024441182423665
              ],
              [
                8.260748522240545,
                60.98616496018867
              ],
              [
                8.288214342553045,
                60.972507494857
              ],
              [
                8.456501575909726,
                60.934037587630414
              ],
              [
                8.528599354230039,
                60.902665295445466
              ],
              [
                8.679007171532511,
                60.876573586244106
              ],
              [
                8.716657657761514,
                60.914070466225716
              ],
              [
                8.636106811091352,
                60.98360931295703
              ],
              [
                8.401274047419477,
                61.06039441111216
              ],
              [
                8.329862914606977,
                61.08497204751243
              ],
              [
                8.291410766169477,
                61.09393481419019
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.113019261961218,
                60.821373934301626
              ],
              [
                8.079373632078406,
                60.803961520850585
              ],
              [
                8.179623876219031,
                60.76374286010738
              ],
              [
                8.252408300047156,
                60.75267387652377
              ],
              [
                8.313519750242468,
                60.75602851734618
              ],
              [
                8.311116490965125,
                60.78938808899414
              ],
              [
                8.277814183836218,
                60.80278919118797
              ],
              [
                8.219792638426062,
                60.81300376408915
              ],
              [
                8.163831029539343,
                60.81518021897127
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                7.799687747615032,
                60.90622015876132
              ],
              [
                7.784243015575978,
                60.876822814940404
              ],
              [
                7.820973758357219,
                60.87749398783465
              ],
              [
                8.17528284038847,
                60.85409311945854
              ],
              [
                8.267979983943157,
                60.85409311945854
              ],
              [
                8.265233401911907,
                60.87983313167029
              ],
              [
                8.21922815288847,
                60.899208015543245
              ],
              [
                8.037267093318157,
                60.90488463131802
              ],
              [
                7.916417483943157,
                60.93025008822325
              ],
              [
                7.844319705622844,
                60.93025008822325
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.194634100748072,
                60.98241518751795
              ],
              [
                8.17643799479104,
                60.960424524897135
              ],
              [
                8.18845429117776,
                60.941920602471136
              ],
              [
                8.22415985758401,
                60.94558890149419
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.087914754889058,
                60.56995757754596
              ],
              [
                8.017876913092183,
                60.59626332416056
              ],
              [
                7.916253377935933,
                60.62726309239004
              ],
              [
                7.816689779303121,
                60.63803864109237
              ],
              [
                7.745278646490621,
                60.6430884399209
              ],
              [
                7.582543661139058,
                60.67135269561135
              ],
              [
                7.525552083990621,
                60.661934032790505
              ],
              [
                7.605202962896871,
                60.599971385802895
              ],
              [
                7.671807577154683,
                60.59525196071079
              ],
              [
                7.794717123053121,
                60.591880520426294
              ],
              [
                7.949212362310933,
                60.555446530928926
              ],
              [
                8.001054098150776,
                60.54768213474002
              ],
              [
                8.067315389654683,
                60.553927556576134
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                7.6482265553305195,
                60.74394938207345
              ],
              [
                7.657152946932082,
                60.71541301283331
              ],
              [
                7.718951042635207,
                60.726159092826336
              ],
              [
                7.8500985830148995,
                60.733039891415
              ],
              [
                7.7429836354086445,
                60.83844150935089
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    });

// Here we will calculate areas for all kommune in Viken for:
  // 9-class typology 2016
  // 9-class typology 2022
  // 4-class change typology 2016-2022

var kommune = ee.FeatureCollection('users/zandersamuel/NINA/Vector/Norway_administrative_kommuner_2022')
kommune = kommune.filterBounds(geometry);
Map.addLayer(kommune, {}, 'kommuner',0)

var dw2016 = ee.Image('projects/nina/GIS_synergy/Extent/Viken/viken_9cat_2016');
print(dw2016)
var dw2022 = ee.Image('projects/nina/GIS_synergy/Extent/Viken/viken_9cat_2022');

var dwChange = ee.Image('projects/nina/GIS_synergy/Extent/Viken/viken_change_dw_trendBased_2016_2022')
var patchImg = ee.Image(0).paint(geometry2, 1)
dwChange = dwChange.where(patchImg, 1)

Map.setOptions('HYBRID')
var CLASS_NAMES = [
    'water', 'trees', 'grass', 'flooded_vegetation', 'crops',
    'shrub_and_scrub', 'built', 'bare', 'snow_and_ice'];

var lcDict = {
  labels: [
    "Build area", //1
    "Crops", //2
    "Bare ground", //3
    "Grass", //4
    "Shrub & scrub", //5
    "Trees", //6
    "Flooded vegetation", //7
    "Water", //8
    "Snow & ice" //9
    ],
  colors: [
    '#C4281B',
    '#E49635',
    '#A59B8F',
    '#88B053',
    '#DFC35A',
    '#397D49',
    '#f2bac1', // '#7A87C6'
    '#0002f6', // '#419BDF'
    '#6fdbde' // #B39FE1'
  ]
}
var lcVizParams = {
  min: 1,
  max: 9,
  palette: lcDict['colors']
};



Map.addLayer(dw2016, lcVizParams, 'dw2016',0);
Map.addLayer(dw2022, lcVizParams, 'dw2022',0);
Map.addLayer(dwChange.randomVisualizer(), {}, 'lcChange_dw',0)

doExport(dw2016, 'dw2016')
doExport(dw2022, 'dw2022')
doExport(dwChange, 'dwChange_2016_2022')

function doExport(image, label){
  var areas = kommune.map(getAreas(image)).flatten();
  areas = areas.map(function(feat){ return feat.set('batch', label)})
  print(areas)
  
  Export.table.toDrive({
    collection: areas,
    description: 'dw_areas_' + label,
    fileFormat: 'CSV'
  })
}

function getAreas(img){
  return function(ft){
    var geo = ft.geometry()
    var areaImage = ee.Image.pixelArea().addBands(img).reproject(dw2016.projection());
    var areas = areaImage.reduceRegion({
      reducer: ee.Reducer.sum().group({
        groupField: 1,
        groupName: 'lc',
      }),
      geometry: geo,
      //scale: 5, //////////// gets default based on projection
      maxPixels: 1e10
    });
    var classAreas = ee.List(areas.get('groups'));
    var classAreaLists = classAreas.map(function(item) {
      var areaDict = ee.Dictionary(item);
      var classNumber = ee.Number(areaDict.get('lc')).format();
      var area = ee.Number(
      areaDict.get('sum')).round();
      return ee.Feature(null, {classNumber: classNumber, area: area});
    });
    var result = ee.FeatureCollection(classAreaLists);
    
    result = result.map(function(f){
      return f.set({kommunenum: ft.get('kommunenum'), navn: ft.get('navn')})
    })
    
    return result
  }
  
}
  
