var geometry = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[10.333055190530173, 59.704433833882405],
          [10.451720223706035, 59.54317856760941],
          [10.635179213967673, 59.45410553877239],
          [10.701097182717673, 59.19065792344536],
          [10.701097182717673, 58.94217106749486],
          [11.030687026467673, 58.9931442859917],
          [11.118577651467673, 59.09486477318654],
          [11.360276870217673, 59.13997729450203],
          [11.514085463967673, 58.936502722821416],
          [11.645921401467673, 58.998803324994924],
          [11.722825698342673, 59.19065792344536],
          [11.777757338967673, 59.28618325810229],
          [11.612962417092673, 59.60452599488652],
          [11.755784682717673, 59.68780318846231],
          [11.843675307717673, 59.79299120471558],
          [11.722825698342673, 60.05725803962274],
          [11.547044448342673, 60.15581629147681],
          [11.459153823342673, 60.25953039223088],
          [11.272386245217673, 60.39006955871449],
          [11.184495620217673, 60.503863701906674],
          [11.151536635842673, 60.57410812019912],
          [11.096604995217673, 60.50927253252037],
          [10.832933120217673, 60.444306959012],
          [10.723069838967673, 60.465976603978405],
          [10.931810073342673, 60.40635027592216],
          [10.953782729592673, 60.319425636015524],
          [10.832933120217673, 60.28132317703108],
          [10.327562026467673, 60.28676910555206],
          [10.250657729592673, 60.34117852983267],
          [10.052903823342673, 60.465976603978405],
          [10.028184585061423, 60.59972711934252],
          [9.959520034280173, 60.6239877375226],
          [9.975992184604356, 60.61454846528305],
          [9.937525360027072, 60.5943344072464],
          [9.888108901467673, 60.57949600117914],
          [9.833177260842673, 60.53899573389177],
          [9.899095229592673, 60.4578429240279],
          [9.822190932717673, 60.43074682184625],
          [9.602464370217673, 60.50114970291184],
          [9.404710463967673, 60.52818709430065],
          [9.338792495217673, 60.61455522001532],
          [9.261888198342673, 60.727563538048656],
          [9.152024917092673, 60.775874318884384],
          [8.866380385842673, 60.88297141856115],
          [8.655188184493733, 60.906420966483694],
          [8.514817885842673, 60.9897103093815],
          [8.306077651467673, 61.011015175387485],
          [8.245536800289996, 60.96707252895174],
          [8.108323745217673, 60.93638558832352],
          [8.082111569015295, 60.88834272223673],
          [7.888597182717674, 60.8669297096516],
          [7.778733901467674, 60.80268222113145],
          [7.756641776297517, 60.73962211303264],
          [7.635911635842674, 60.69531592217877],
          [7.567247085061424, 60.689265891306924],
          [7.657884292092674, 60.65765279143281],
          [7.756761245217674, 60.53899573389177],
          [7.723802260842674, 60.36562392756484],
          [7.602952651467674, 60.15307319895811],
          [7.811692885842674, 60.14213592927642],
          [8.097337417092673, 60.207705002100774],
          [8.382981948342673, 60.19678591146744],
          [8.701585463967673, 60.207705002100774],
          [8.899339370217673, 60.16400683120625],
          [8.976243667092673, 60.103826828888394],
          [9.031175307717673, 60.04902216100538],
          [9.042161635842673, 59.99962004811569],
          [9.195970229592673, 59.96114510353437],
          [9.236837281630184, 59.84222704045716],
          [9.44297476109079, 59.75506522420387],
          [9.567182756500898, 59.52216385025981],
          [9.737758193359895, 59.43279037798038],
          [9.725322095151471, 59.48979837270648],
          [9.833838182438045, 59.50494327029045],
          [9.915274697889362, 59.641070692000135],
          [9.989472883693375, 59.688175953113905]]]),
    geometry2 = /* color: #d63000 */ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.238775865990545,
                61.078614562248106
              ],
              [
                8.217489855248358,
                61.024441182423665
              ],
              [
                8.260748522240545,
                60.98616496018867
              ],
              [
                8.288214342553045,
                60.972507494857
              ],
              [
                8.456501575909726,
                60.934037587630414
              ],
              [
                8.528599354230039,
                60.902665295445466
              ],
              [
                8.679007171532511,
                60.876573586244106
              ],
              [
                8.716657657761514,
                60.914070466225716
              ],
              [
                8.636106811091352,
                60.98360931295703
              ],
              [
                8.401274047419477,
                61.06039441111216
              ],
              [
                8.329862914606977,
                61.08497204751243
              ],
              [
                8.291410766169477,
                61.09393481419019
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.113019261961218,
                60.821373934301626
              ],
              [
                8.079373632078406,
                60.803961520850585
              ],
              [
                8.179623876219031,
                60.76374286010738
              ],
              [
                8.252408300047156,
                60.75267387652377
              ],
              [
                8.313519750242468,
                60.75602851734618
              ],
              [
                8.311116490965125,
                60.78938808899414
              ],
              [
                8.277814183836218,
                60.80278919118797
              ],
              [
                8.219792638426062,
                60.81300376408915
              ],
              [
                8.163831029539343,
                60.81518021897127
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                7.799687747615032,
                60.90622015876132
              ],
              [
                7.784243015575978,
                60.876822814940404
              ],
              [
                7.820973758357219,
                60.87749398783465
              ],
              [
                8.17528284038847,
                60.85409311945854
              ],
              [
                8.267979983943157,
                60.85409311945854
              ],
              [
                8.265233401911907,
                60.87983313167029
              ],
              [
                8.21922815288847,
                60.899208015543245
              ],
              [
                8.037267093318157,
                60.90488463131802
              ],
              [
                7.916417483943157,
                60.93025008822325
              ],
              [
                7.844319705622844,
                60.93025008822325
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.194634100748072,
                60.98241518751795
              ],
              [
                8.17643799479104,
                60.960424524897135
              ],
              [
                8.18845429117776,
                60.941920602471136
              ],
              [
                8.22415985758401,
                60.94558890149419
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                8.087914754889058,
                60.56995757754596
              ],
              [
                8.017876913092183,
                60.59626332416056
              ],
              [
                7.916253377935933,
                60.62726309239004
              ],
              [
                7.816689779303121,
                60.63803864109237
              ],
              [
                7.745278646490621,
                60.6430884399209
              ],
              [
                7.582543661139058,
                60.67135269561135
              ],
              [
                7.525552083990621,
                60.661934032790505
              ],
              [
                7.605202962896871,
                60.599971385802895
              ],
              [
                7.671807577154683,
                60.59525196071079
              ],
              [
                7.794717123053121,
                60.591880520426294
              ],
              [
                7.949212362310933,
                60.555446530928926
              ],
              [
                8.001054098150776,
                60.54768213474002
              ],
              [
                8.067315389654683,
                60.553927556576134
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                7.6482265553305195,
                60.74394938207345
              ],
              [
                7.657152946932082,
                60.71541301283331
              ],
              [
                7.718951042635207,
                60.726159092826336
              ],
              [
                7.8500985830148995,
                60.733039891415
              ],
              [
                7.7429836354086445,
                60.83844150935089
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    });



/*
  // Global Objects ///////////////////////////////////////////////////////////////////////////////
*/
var animation = require('users/gena/packages:animation')

var kommuner = ee.FeatureCollection('users/zandersamuel/NINA/Vector/Norway_administrative_kommuner_2022')
kommuner = kommuner.filterBounds(geometry);
print(kommuner.size())

var kommunerNames = [
  "Aremark",
  "Asker",
  "Aurskog-Høland",
  "Bærum",
  "Drammen",
  "Eidsvoll",
  "Enebakk",
  "Flesberg",
  "Flå",
  "Fredrikstad",
  "Frogn",
  "Frogn",
  "Gjerdrum",
  "Gol",
  "Halden",
  "Hemsedal",
  "Hol",
  "Hole",
  "Hurdal",
  "Hvaler",
  "Indre Østfold",
  "Jevnaker",
  "Kongsberg",
  "Krødsherad",
  "Lier",
  "Lillestrøm",
  "Lunner",
  "Lørenskog",
  "Marker",
  "Modum",
  "Moss",
  "Nannestad",
  "Nes",
  "Nesbyen",
  "Nesodden",
  "Nittedal",
  "Nordre Follo",
  "Nore og Uvdal",
  "Oslo",
  "Rakkestad",
  "Ringerike",
  "Rollag",
  "Råde",
  "Rælingen",
  "Sarpsborg",
  "Sigdal",
  "Skiptvet",
  "Ullensaker",
  "Vestby",
  "Våler",
  "Ål",
  "Ås",
  "Øvre Eiker"
]

// Extent 9-class without uncertainty
var ext9class = ee.FeatureCollection('projects/nina/GIS_synergy/Extent/Viken/extent_accounts_9class')
ext9class = orderTable(ext9class);
print(ext9class.filter(ee.Filter.eq('kommunenum', 3001)), 'ext9class')

// Extent 2-class with uncertainty
var ext2class = ee.FeatureCollection('projects/nina/GIS_synergy/Extent/Viken/extent_accounts_2class_uncertainty')
ext2class = ext2class.select(['Areal type', 'area', '95% CI', 'navn'], ['Areal type', 'Areal', '95% CI', 'navn'])
print(ext2class.filter(ee.Filter.eq('navn', 'Fredrikstad')), 'ext2class')


// Sentinel-2 band names
var S2_BANDS = ['QA60', 'B1','B2','B3','B4', 'B5', 'B6', 'B7','B8','B11','B12']; // Sentinel bands
var S2_NAMES = ['QA60','cb', 'blue', 'green', 'red', 'R1', 'R2', 'R3','nir','swir1', 'swir2']; // Common names


// Extent -------------------------------------------------------------------------------------

var dw2016 = ee.Image('projects/nina/GIS_synergy/Extent/Viken/viken_9cat_2016');
print(dw2016)
var dw2022 = ee.Image('projects/nina/GIS_synergy/Extent/Viken/viken_9cat_2022');

var dwChange = ee.Image('projects/nina/GIS_synergy/Extent/Viken/viken_change_dw_trendBased_2016_2022')
var patchImg = ee.Image(0).paint(geometry2, 1)
dwChange = dwChange.where(patchImg, 1);
dwChange = dwChange.updateMask(dwChange.eq(2).or(dwChange.eq(3))).remap([2,3], [0,1]).focal_mode()

// Text and panel styles
var titleStyle = {fontFamily:'cormorantgaramond-light', fontSize:'30px',color:'#000000',  backgroundColor: '#ffffff'};
var labelSelectorStyle = {fontFamily:'sans-serif', fontSize:'14px', color:'#322220',backgroundColor: '#ffffff', margin: '14px 4px 0px 8px'}
var headingStyle = {fontFamily:'cormorantgaramond-light', fontSize:'20px', color:'#000000',backgroundColor: '#ffffff'};
var textStyle = {fontFamily:'sans-serif', fontSize:'14px', color:'#322220',backgroundColor: '#ffffff'};
var textStyleBold = {fontFamily:'sans-serif', fontSize:'14px', color:'#322220',backgroundColor: '#ffffff', fontWeight: 'bold'};

// Viz styles
var virdis_inv = ['#440154','#472878','#3E4A89','#31688E','#25838E','#1E9E89','#35B779','#6CCE59','#B5DE2C','#FDE725']
var magmaPal = ['#400b0b', '#a12424', '#ee7b06', '#ffa904', '#ffdb00', '#ffffff'];


var lcDict = {
  labels: [
    "Bebygd", //1
    "Avling", //2
    "Barmark", //3
    "Gress", //4
    "Busk", //5
    "Skog", //6
    "Våtmark", //7
    "Vann", //8
    "Snø og is" //9
    ],
  colors: [
    '#C4281B',
    '#E49635',
    '#A59B8F',
    '#88B053',
    '#DFC35A',
    '#397D49',
    '#f2bac1', // '#7A87C6'
    '#0002f6', // '#419BDF'
    '#b9e0e1' // #B39FE1'
  ]
}
var lcVizParams = {
  min: 1,
  max: 9,
  palette: lcDict['colors']
};

var lcChangeViZParams = {
  min:0,
  max:1,
  palette:['#ff80f7', '#17ede3']
}

// Pre-initialized objects
var knameSelect = null;
var knumSelect = null;


/*
  // UI widgets ///////////////////////////////////////////////////////////////////////////////
*/

// Map layers
var dw2016Layer = ui.Map.Layer(dw2016, lcVizParams, 'økosystemareal 2016', 0);
var dw2022Layer = ui.Map.Layer(dw2022, lcVizParams, 'økosystemareal 2022');
var dwChangeLayer = ui.Map.Layer(dwChange, lcChangeViZParams, 'økosystemareal endring');
var startLayer = ui.Map.Layer(kommuner.style({fillColor: '#00000000', color:'#ffffff', width:1}), {}, 'kommuner')

// Panels
var infoPanel = ui.Panel({style: {width: '30%'}});

var statsPanel = ui.Panel();

var extentPanelShown = true;
var extentPanel = ui.Panel({style: {shown: extentPanelShown}});

var panelBreak25 = ui.Panel(null, null, {stretch: 'horizontal', height: '1px', backgroundColor: '000', margin: '8px 0px 8px 0px'});

var titleTextPanel = ui.Panel([
  ui.Label('NINA økosystemregnskap for Viken ', titleStyle),
  ui.Label('Endringer i økosystemareal 2016 til 2022',headingStyle),
  panelBreak25
]);

var instructionPanel = ui.Panel([], ui.Panel.Layout.flow('horizontal', true));
var initualInstruction = ui.Label('Velg en kommune: ',labelSelectorStyle)
var kommuneSelector = ui.Select({items: kommunerNames, placeholder: 'velg',onChange: handleKommuneSelect })
instructionPanel.widgets().reset([initualInstruction, kommuneSelector])

infoPanel
  .add(titleTextPanel)
  .add(instructionPanel)


// Legends
var legendPanel = ui.Panel({style:{position:'bottom-left', maxHeight:'350px'}});
var legendSubPanel = ui.Panel({
  widgets: [
    createCatLegend(lcDict, 'Økosystem type'),
    createCatLegend({'labels': ['Nedbygging', 'Gjengroing'], colors: ['#ff80f7', '#17ede3']}, 'Økosystem endring'),
    ],
  style: {shown: false}
  
})
var legendButton = ui.Button('Se tegnforklaring', handleLegend)
legendPanel.add(legendSubPanel).add(legendButton)

// Timelapse panel
var panelTimeLapse = ui.Panel({
  style:{ width: '400px', 'height': '400px', position: 'bottom-right', 'background-color': 'ffffff80', shown: false }
});




/*
  // UI deploy ///////////////////////////////////////////////////////////////////////////////
*/
var map = ui.Map();
map.setOptions('HYBRID')
map.setCenter(10.569, 59.751, 8)
map.setControlVisibility({
  mapTypeControl:true, 
  layerList: true, 
  zoomControl: true, 
  fullscreenControl: true});
map
  .add(legendPanel)
  .add(panelTimeLapse);
map.onClick(handleMapClick);


map.layers().reset([dw2016Layer, dw2022Layer, dwChangeLayer, startLayer]);

var splitPanel = ui.SplitPanel(infoPanel, map);

ui.root.clear();
ui.root.widgets().reset([splitPanel]);

/*
  // Global functions ///////////////////////////////////////////////////////////////////////////////
*/



var legShow = false;
function handleLegend(){
  if(legShow){
    legShow = false;
    legendButton.setLabel('Se tegnforklaring');
    legendSubPanel.style().set('shown', false);
  } else {
    legShow = true;
    legendButton.setLabel('Gjemme tegnforklaring'); 
    
    legendSubPanel.style().set('shown', true);
  }
 
}


function handleKommuneSelect(val){
  
  statsPanel.clear()
  
  infoPanel.widgets().reset([ titleTextPanel,instructionPanel, statsPanel]);
  
  knameSelect = val
  var komSelect = kommuner.filter(ee.Filter.eq('navn', knameSelect)).first();
  
  var kstyled = kommuner.filter(ee.Filter.neq('navn', knameSelect)).style({fillColor: '#666666'})
  var klayer = ui.Map.Layer(kstyled, {opacity: 0.9}, 'kommuner')
  
  map.layers().reset([dw2016Layer, dw2022Layer, dwChangeLayer, klayer]);
  map.centerObject(komSelect);
  
  var propertyLabel = ui.Label('Regnskap for ' + knameSelect , textStyleBold);
  
  var mapClickInstruction = ui.Label('Klikk på kartet for å se satellitttidsserier' , textStyleBold);
  
  extentPanel.clear();
  extentPanel.add(makeExtentTable_9class(knameSelect, '9-klass uten usikkerhet (km2)'))
  
  var klist = ['Fredrikstad', 'Hol', 'Bærum', 'Asker', 'Gol', 'Hole', 'Sarpsborg', 'Hemsedal']
  if (klist.indexOf(knameSelect) !== -1){
    extentPanel
      .add(makeExtentTable_2class(knameSelect, 'Endrings 4-klasse med usikkerhet (km2)'))
  }
  
  statsPanel.widgets().reset([propertyLabel, extentPanel, mapClickInstruction ])

  
}


var clickedPoint;
var boundLayer;

function handleMapClick(p){
  
  if (!knameSelect) return
  
  removeReferenceImagesMap();
  if (boundLayer) map.layers().remove(boundLayer);
  
  clickedPoint = [p.lon, p.lat]
  print(clickedPoint)
  
  var ptTrans = ee.Geometry.Point(p.lon, p.lat).transform('EPSG:32633').coordinates()
  
  ptTrans.evaluate(function(coords){
    // https://norgeibilder.no/?x=289128&y=6672345&level=14&utm=33&projects=&layers=&plannedOmlop=0&plannedGeovekst=0
    var urlString = 'https://norgeibilder.no/?x=' + String(coords[0]) + '&y=' + String(coords[1]) + '&level=14&utm=33&projects=&layers=&plannedOmlop=0&plannedGeovekst=0'
    var norgeibilderLabel = ui.Label({
      value: 'Se i Norgeibilder (' + String(Math.round(p.lat*1000)/1000) + ' ' + String(Math.round(p.lon*1000)/1000) + ')',
      targetUrl: urlString
    })
    
    statsPanel.add(norgeibilderLabel)
  })
  
  
  
  showReferenceImages()
}

function showReferenceImages() {
  
  var pt = clickedPoint
  
  var scale = map.getScale()
  scale = Math.min(19.093, scale)
  var center = ee.Geometry.Point(pt)
  var bounds = center.buffer(scale * 120).bounds(scale)
  
  var zoom = map.getZoom()
  
  var missions = []
  
  var images = getS2(center);
  print('s2 image length', images.size())
  
  
  images = images.map(function(i) { 
    return i.set({ label: i.date().format('YYYY-MM-dd') })
  })

  images = images.randomColumn('rnd', 123).sort('rnd').limit(50)
  images = images.sort('system:time_start')
  
  var mapZoom = Math.max(8, zoom)

  // animate images    
  var map2 = ui.Map({ lat: pt[1], lon: pt[0] , zoom: mapZoom }, false, { height: '380px', width: '380px', position: 'middle-right'})
  
  // add close button
  var closeMapButton = ui.Button('Close')
  closeMapButton.style().set({ margin: '0px', padding: '0px', textAlign: 'left', position: 'bottom-right' })
  map2.add(closeMapButton)
  
  closeMapButton.onClick(function() {
    removeReferenceImagesMap()
  })
  
  map2.setOptions('SATELLITE')
  map2.centerObject(bounds, mapZoom, setBounds)
  map2.setControlVisibility({all: false,/*, layerList: true*/ scaleControl: true})
  map2.setLocked(true)
  
  var style = {
    'Deep': [{
        featureType: 'all',
        stylers: [{ color: '#ffffff'}]
    }]
  };
  map2.setOptions('Deep', style)
  
  function setBounds(){
    var boundToMap = ee.FeatureCollection([ee.Feature(ee.Geometry.Rectangle(map2.getBounds()))]).style({fillColor:'#00000000', color:'#ff0000'});
    boundLayer = ui.Map.Layer(boundToMap, {}, 'inset map bounds');
    map.layers().set(4, boundLayer)
  }
  
  
  panelTimeLapse.widgets().reset([map2])
  panelTimeLapse.style().set({ shown: true })

  var vis = {min:0, max:2000, bands: ['red', 'green', 'blue']}

  var a = animation.animate(images, { 
    vis: vis,
    map: map2, 
    compact: true, 
    hidePlay: true, 
    maxFrames: 50, 
    width: '250px',
    label: 'label',
    // preloadCount: 1
  })

  a.then(function() {
    // map.addLayer(ee.FeatureCollection([bounds]).style({ width: 2, color: '00ffff', fillColor: '00ffff11' }), {}, 'bounds')

    // var edges = ee.Algorithms.CannyEdgeDetector(image.select('Alert').unmask(0, false).resample(resamplingMode), 0.1)
    // map.addLayer(edges.selfMask(), { palette: ['fd8d3c'], min: 0, max: 1 }, 'alert', true, 0.5)

    a.panel.style().set({ 'background-color': '#00000080' })
    a.panel.widgets().get(0).style().set({ 'background-color': '#00000000' })
    a.panel.widgets().get(1).style().set({ 'background-color': '#00000000' })
    a.panel.widgets().get(2).style().set({ 'background-color': '#00000000' })
    a.panel.widgets().get(0).style().set({ 'color': '#000000' })
    a.panel.widgets().get(1).style().set({ 'color': '#000000' })
    a.panel.widgets().get(1).style().set({ fontSize: 0 })
    a.panel.widgets().get(2).style().set({ 'color': '#ffffff' })
    
    // change properties of the main panel of animation controls
    // print(a.panel)
    // a.panel.widgets().reset([])
  })

}

function removeReferenceImagesMap(){
  panelTimeLapse.widgets().reset([])
  panelTimeLapse.style().set({ shown: false });
  map.layers().remove(boundLayer);
}



//This procedure must be used for proper processing of S2 imagery
function uniqueValues(collection,field){
    var values  =ee.Dictionary(collection.reduceColumns(ee.Reducer.frequencyHistogram(),[field]).get('histogram')).keys();
    return values;
  }
function dailyMosaics(imgs){
  //Simplify date to exclude time of day
  imgs = imgs.map(function(img){
  var d = ee.Date(img.get('system:time_start'));
  var day = d.get('day');
  var m = d.get('month');
  var y = d.get('year');
  var simpleDate = ee.Date.fromYMD(y,m,day);
  return img.set('simpleTime',simpleDate.millis());
  });
  
  //Find the unique days
  var days = uniqueValues(imgs,'simpleTime');
  
  imgs = days.map(function(d){
    d = ee.Number.parse(d);
    d = ee.Date(d);
    var t = imgs.filterDate(d,d.advance(1,'day'));
    var f = ee.Image(t.first());
    t = t.mosaic();
    t = t.set('system:time_start',d.millis());
    t = t.copyProperties(f);
    return t;
    });
    imgs = ee.ImageCollection.fromImages(imgs);
    
    return imgs;
}

function getS2(aoi) { 
  var s2 = ee.ImageCollection("COPERNICUS/" + 'S2_SR')
    .filterBounds(aoi)
    .filterMetadata('CLOUDY_PIXEL_PERCENTAGE', 'less_than', 20)
    .filter(ee.Filter.calendarRange(2016, 2022, 'year'))
    .filter(ee.Filter.calendarRange(6,8, 'month'))
    .select(S2_BANDS, S2_NAMES)
  s2 = dailyMosaics(s2)
  
  return s2
}


function orderTable(table){
  table = table.map(function(ft){ return ft.set('orderVal', ft.get('year'))})
  return table.remap(['2016', 'Endring','2022'], [1,2,3], 'orderVal').sort('orderVal')
}


function makeExtentTable_2class(kname, title){
  
  var extFiltered = ext2class.filter(ee.Filter.eq('navn', kname))
  
  var cList = ['Areal type', 'Areal', '95% CI']
  var rList = ['bebygd - stabil', 'ikke bebygd - stabil', 'nedbygging', 'gjengroing'];
  
  var rows = ee.List(rList).map(function(r){
    
    var rowSub = ee.List(cList).map(function(c){
       var rowSelect = extFiltered.filter(ee.Filter.eq('Areal type', r)).first();
       return  {v: rowSelect.get(c)}
    })
    return {c: rowSub}
  })
  
  var dataTable = {
    cols: [{id: cList[0], label: cList[0], type: 'string'},
           {id: cList[1], label: cList[1], type: 'number'},
           {id: cList[2], label: cList[2], type: 'number'}],
    rows: rows
  }
  var chart = ui.Chart(ee.Dictionary(dataTable).getInfo())
    .setChartType('Table')
    .setOptions({
      title: '',
      allowHtml: true,
  pageSize: 4
    });
  
  return ui.Panel([ui.Label(title), chart])

}

function makeExtentTable_9class(kname, title){
  
  var extFiltered = ext9class.filter(ee.Filter.eq('navn', kname))
  
  var cList = ['year','Bebygd', 'Avling', 'Barmark', 'Gress', 'Busk', 'Skog', 'Våtmark', 'Vann', 'Snø og is']
  var rList = ['2016', 'Endring', '2022'];
  
  var rows = ee.List(rList).map(function(r){
    
    var rowSub = ee.List(cList).map(function(c){
       var rowSelect = extFiltered.filter(ee.Filter.eq('year', r)).first();
       return  {v: rowSelect.get(c)}
    })
    return {c: rowSub}
  })
  
  var dataTable = {
    cols: [{id: cList[0], label: cList[0], type: 'string'},
           {id: cList[1], label: cList[1], type: 'number'},
           {id: cList[2], label: cList[2], type: 'number'},
           {id: cList[3], label: cList[3], type: 'number'},
           {id: cList[4], label: cList[4], type: 'number'},
           {id: cList[5], label: cList[5], type: 'number'},
           {id: cList[6], label: cList[6], type: 'number'},
           {id: cList[7], label: cList[7], type: 'number'},
           {id: cList[8], label: cList[8], type: 'number'},
           {id: cList[9], label: cList[9], type: 'number'}],
    rows: rows
  }
  
    var chart = ui.Chart(ee.Dictionary(dataTable).getInfo())
      .setChartType('Table')
      .setOptions({
        title: '',
        allowHtml: true,
        pageSize: 3
      });
  
  return ui.Panel([ui.Label(title), chart])

}


function createCatLegend(dict, title) {
  var panel = ui.Panel()
  
  // Create and add the legend title.
  var legendTitle = ui.Label({
    value: title,
    style: {
      fontWeight: 'bold',
      fontSize: '18px',
      margin: '0 0 4px 0',
      padding: '0'
    }
  });
  panel.add(legendTitle);
  
  var loading = ui.Label('Loading legend...', {margin: '2px 0 4px 0'});
  panel.add(loading);
  
  // Creates and styles 1 row of the legend.
  var makeRow = function(color, name) {
    // Create the label that is actually the colored box.
    var colorBox = ui.Label({
      style: {
        backgroundColor: color,
        // Use padding to give the box height and width.
        padding: '8px',
        margin: '0 0 4px 0'
      }
    });
  
    // Create the label filled with the description text.
    var description = ui.Label({
      value: name,
      style: {margin: '0 0 4px 6px'}
    });
  
    return ui.Panel({
      widgets: [colorBox, description],
      layout: ui.Panel.Layout.Flow('horizontal')
    });
  };
  
  // Get the list of palette colors and class names from the image.
  var palette = dict['colors'];
  var names = dict['labels'];
  loading.style().set('shown', false);
  
  for (var i = 0; i < names.length; i++) {
    panel.add(makeRow(palette[i], names[i]));
  }
  
  return panel
  
}

function createLegend(title, minVal, maxVal, minLab, maxLab, palette) { 
  var geometry = ee.Geometry.Polygon(
          [[[-54, -4.05],
            [-53, -4.05],
            [-53, -4.00],
            [-54, -4.00]]]);
  
  var latlong = ee.Image.pixelLonLat();
  
  var legend = ui.Panel({
      style: {
          position: 'bottom-right',
          //backgroundColor: '202020'
      }
  });
  
  // layer 1
  var obj = {
      "title": ui.Label({
          "value": title,
          "style": {
              "fontSize": '14px',
              "margin": '3px 0 0 3px',
          }
      }),
      "bar": ui.Thumbnail({
          "image": latlong.clip(geometry).visualize({
              "bands": ['longitude'],
              "min": -54,
              "max": -53,
              "palette": palette
          }),
          "params": {
              "region": geometry.toGeoJSON(),
              "format": 'png'
          },
          "style": {
              "height": '20px',
              "width": '165px',
              "margin": '-1px 0 0 8px',
              "border": '1px solid gray'
          }
      }),
      "panel1": ui.Panel({
          "layout": ui.Panel.Layout.flow('horizontal'),
      }),
      "panel2": ui.Panel({
          "layout": ui.Panel.Layout.flow('horizontal'),
      }),
      "minAxis": ui.Label({
          "value": minVal,
          "style": {
              "margin": '0 0 0 4px',
              "fontSize": '12px'
          }
      }),
      "maxAxis": ui.Label({
          "value": maxVal,
          "style": {
              "margin": '0 0 0 150px',
              "fontSize": '12px'
          }
      }),
      "minLabel": ui.Label({
          "value": minLab,
          "style": {
              "margin": '0 0 0 6px',
              "fontSize": '12px'
          }
      }),
      "maxLabel": ui.Label({
          "value": maxLab,
          "style": {
              "margin": '0 0 0 130px',
              "fontSize": '12px'
          }
      })
  };
  
  /**
   *
   */
  var legendAddLayer = function(legend, layer) {
  
      legend.add(layer.title);
      layer.panel1.add(layer.minAxis);
      layer.panel1.add(layer.maxAxis);
      layer.panel2.add(layer.minLabel);
      layer.panel2.add(layer.maxLabel);
      legend.add(layer.panel1);
      legend.add(layer.bar);
      legend.add(layer.panel2);
  
      return legend;
  };
  
  return legendAddLayer(legend, obj);
  
};


